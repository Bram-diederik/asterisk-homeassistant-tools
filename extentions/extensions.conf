[general]
static=yes
writeprotect=no
clearglobalvars=no

[pstn-incoming]
exten => 1234,1,log(NOTICE, pstn-incoming ${CALLERID(num)} )
exten => 1234,2,GotoIF($[("${CALLERID(num)}") = "anonymous"]?anonymous,in,1)
exten => 1234,3,GotoIf($["${DB(denylist/${CALLERID(num)})}" = "1"]?denylist,denylist,1)
exten => 1234,4,Log(NOTICE, Call from ${CALLERID(num)} )
exten => 1234,5,System(/opt/sascha/nextcloud/search_name.php ${CALLERID(num)})
exten => 1234,6,Set(CALLERID(NAME)=${SHELL(cat /opt/sascha/nextcloud/name.txt)})
exten => 1234,7,GotoIf($["${SHELL(/opt/sascha/asterisk/read.php "${SHELL(cat /opt/sascha/nextcloud/group.txt)}") }" = "0"]?13)
exten => 1234,8,GotoIf($["${SHELL(grep -q ${CALLERID(num)} /opt/sascha/nextcloud/calendar_calls.txt && echo -n found || echo -n notfound)}" = "found"])?,13)
exten => 1234,9,Log(NOTICE, Pickup Sascha ${CALLERID(num)} )
exten => 1234,10,System(/opt/gnomepub/smskarinpickup.sh&)
exten => 1234,11,Goto(sascha_pickup,pickup,1)
exten => 1234,12,HangUp()
exten => 1234,13,System(/opt/sascha/homeassistant/tts_speak.php nl media_player.googlehome8005 "Inkomende beller ${CALLERID(NAME)}")
exten => 1234,14,Goto(call,callall,1)
exten => 1234,15,Hangup()


[sascha_pickup]
exten => pickup,1,log(NOTICE, sascha call pickup)
exten => pickup,2,Set(dutch=${IF($[${CALLERID(num):0:1} = 0]?1:0)})
exten => pickup,3,System(/opt/HA/asteriskpickup.php)
exten => pickup,4,GotoIf($["${SHELL(cat /opt/vcf2asterisk/group)}" = "Very_close"])?sascha_close,pickup,1)
exten => pickup,5,log(NOTICE, FOOBAR sascha call pickup)
exten => pickup,6,GotoIf($["${SHELL(cat /opt/vcf2asterisk/group)}" = "close"])?sascha_close,pickup,1) 
exten => pickup,7,GotoIf($["${SHELL(cat /opt/vcf2asterisk/group)}" = "all"])?sascha_none,pickup_all,1) 
exten => pickup,8,Goto(sascha_none,pickup_none,1)

[sascha_none]

exten => pickup_none,1,log(NOTICE, sascha none call pickup)
exten => pickup_none,2,GotoIfTime(21:00-23:59|*|*|*?pickup_late_none,1)
exten => pickup_none,3,GotoIfTime(00:00-08:30|*|*|*?pickup_late_none,1)
exten => pickup_none,4,Goto(pickup_unavailable_none,1)

exten => pickup_all,1,log(NOTICE, sascha all call pickup)
exten => pickup_all,2,GotoIf($["${SHELL(cat /opt/HA/busy)}" = "on"])?pickup_busy_all,1)
exten => pickup_all,3,GotoIf($["${SHELL(cat /opt/HA/calendar_item)}" != "off"])?pickup_calendar_all,1)
exten => pickup_all,4,GotoIfTime(21:00-23:59|*|*|*?pickup_late_all,1)
exten => pickup_all,5,GotoIfTime(00:00-08:30|*|*|*?pickup_late_all,1)
exten => pickup_all,6,Goto(pickup_unavailable_all,1)


exten => pickup_late_none,1,log(NOTICE, sascha late none call pickup)
exten => pickup_late_none,2,GotoIf($[${dutch} = 1]?,8)
exten => pickup_late_none,3,log(NOTICE, sascha pickup late English)
exten => pickup_late_none,4,Background(${SHELL(/opt/sascha/tts/gen_late_none_en.php)})
exten => pickup_late_none,5,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_late_none,6,WaitExten(30)
exten => pickup_late_none,7,Hangup()
exten => pickup_late_none,8,Background(${SHELL(cat /opt/sascha/tts/gen_late_none_nl.php)})
exten => pickup_late_none,9,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_late_none,10,WaitExten(30)
exten => pickup_late_none,11,Hangup()

exten => pickup_unavailable_none,1,log(NOTICE, sascha unavailable none call pickup )
exten => pickup_unavailable_none,2,GotoIf($[${dutch} = 1]?,8)
exten => pickup_unavailable_none,3,log(NOTICE, sascha pickup unavailable English)
exten => pickup_unavailable_none,4,Background(${SHELL(/opt/sascha/tts/gen_unavailable_none_en.php)})
exten => pickup_unavailable_none,5,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_unavailable_none,6,WaitExten(30)
exten => pickup_unavailable_none,7,Hangup()
exten => pickup_unavailable_none,8,Background(${SHELL(/opt/sascha/tts/gen_unavailable_none_nl.php)})
exten => pickup_unavailable_none,9,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_unavailable_none,10,WaitExten(30)
exten => pickup_unavailable_none,11,Hangup()

exten => pickup_late_all,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_late_all,2,log(NOTICE, sascha pickup late English)
exten => pickup_late_all,3,Background(${SHELL(/opt/sascha/tts/gen_late_all_en.php)})
exten => pickup_late_all,4,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_late_all,5,WaitExten(30)
exten => pickup_late_all,6,Hangup()
exten => pickup_late_all,7,Background(${SHELL(/opt/sascha/tts/gen_late_all_nl.php)})
exten => pickup_late_all,8,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_late_all,9,WaitExten(30)
exten => pickup_late_all,10,Hangup()

exten => pickup_busy_all,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_busy_all,2,log(NOTICE, sascha pickup busy English)
exten => pickup_busy_all,3,Background(${SHELL(/opt/sascha/tts/gen_busy_all_en.php)})
exten => pickup_busy_all,4,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_busy_all,5,WaitExten(30)
exten => pickup_busy_all,6,Hangup()
exten => pickup_busy_all,7,Background(${SHELL(/opt/sascha/tts/gen_busy_all_nl.php)})
exten => pickup_busy_all,8,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_busy_all,9,WaitExten(30)
exten => pickup_busy_all,10,Hangup()

exten => pickup_calendar_all,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_calendar_all,2,log(NOTICE, sascha pickup calendar English)
exten => pickup_calendar_all,3,Background(${SHELL(/opt/sascha/tts/gen_calendar_all_en.php)})
exten => pickup_calendar_all,4,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_calendar_all,5,WaitExten(30)
exten => pickup_calendar_all,6,Hangup()
exten => pickup_calendar_all,7,Background(${SHELL(/opt/sascha/tts/gen_calendar_all_nl.php)})
exten => pickup_calendar_all,8,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_calendar_all,9,WaitExten(30)
exten => pickup_calendar_all,10,Hangup()

exten => pickup_unavailable_all,1,GotoIf($[${dutch} = 1]?,6)
exten => pickup_unavailable_all,2,log(NOTICE, sascha pickup unavailable English)
exten => pickup_unavailable_all,3,Background(${SHELL(/opt/sascha/tts/gen_unavailable_all_en.php)})
exten => pickup_unavailable_all,4,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_unavailable_all,5,WaitExten(30)
exten => pickup_unavailable_all,6,Hangup()
exten => pickup_unavailable_all,7,Background(${SHELL(/opt/sascha/tts/gen_unavailable_all_nl.php)})
exten => pickup_unavailable_all,8,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_unavailable_all,9,WaitExten(30)
exten => pickup_unavailable_all,10,Hangup()


;redirect to voicemail
exten => 1,1,Log(NOTICE, redirect to voicemail from ${CALLERID(all)} )
exten => 1,n,VoiceMail(6001) 
exten => 1,n,Hangup()

;enter password
exten => 1234,1,Log(NOTICE, entrycode ${CALLERID(all)} )
exten => 1234,n,Goto(sascha_close,pickup,1)
exten => 1234,n,Hangup()

exten => e,1,Goto(pickup_none,1)



[sascha_close]
exten => pickup,1,log(NOTICE, sascha close call pickup)
exten => pickup,2,GotoIf($["${SHELL(cat /opt/HA/busy)}" = "on"])?pickup_busy,1)
exten => pickup,3,GotoIf($["${SHELL(cat /opt/HA/calendar_item)}" != "off"])?pickup_calendar,1)
exten => pickup,4,GotoIfTime(22:30-23:59|*|*|*?pickup_late,1)
exten => pickup,5,GotoIfTime(00:00-08:30|*|*|*?pickup_late,1)
exten => pickup,6,Goto(pickup_unavailable,1)

exten => pickup_busy,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_busy,2,log(NOTICE, sascha pickup busy English)
exten => pickup_busy,3,Background(${SHELL(/opt/sascha/tts/gen_busy_close_en.php)})
exten => pickup_busy,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => pickup_busy,5,WaitExten(30)
exten => pickup_busy,6,Hangup()
exten => pickup_busy,7,Background(${SHELL(/opt/sascha/tts/gen_busy_close_nl.php)})
exten => pickup_busy,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => pickup_busy,9,WaitExten(30)
exten => pickup_busy,10,Hangup()


exten => pickup_late,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_late,2,log(NOTICE, sascha pickup late English)
exten => pickup_late,3,Background(${SHELL(/opt/sascha/tts/gen_late_close_en.php)})
exten => pickup_late,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => pickup_late,5,WaitExten(30)
exten => pickup_late,6,Hangup()
exten => pickup_late,7,Background(${SHELL(/opt/sascha/tts/gen_late_close_nl.php)})
exten => pickup_late,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => pickup_late,9,WaitExten(30)
exten => pickup_late,10,Hangup()

exten => pickup_calendar,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_calendar,2,log(NOTICE, sascha pickup calendar English)
exten => pickup_calendar,3,Background(${SHELL(/opt/sascha/tts/gen_calendar_close_en.php)})
exten => pickup_calendar,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => pickup_calendar,5,WaitExten(30)
exten => pickup_calendar,6,Hangup()
exten => pickup_calendar,7,Background(${SHELL(/opt/sascha/tts/gen_calendar_close_nl.php)})
exten => pickup_calendar,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => pickup_calendar,9,WaitExten(30)
exten => pickup_calendar,10,Hangup()

exten => pickup_unavailable,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_unavailable,2,log(NOTICE, sascha pickup unavailable English)
exten => pickup_unavailable,3,Background(${SHELL(/opt/sascha/tts/gen_unavailable_close_en.php)})
exten => pickup_unavailable,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => pickup_unavailable,5,WaitExten(30)
exten => pickup_unavailable,6,Hangup()
exten => pickup_unavailable,7,Background(${SHELL(/opt/sascha/tts/gen_unavailable_close_nl.php)})
exten => pickup_unavailable,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => pickup_unavailable,9,WaitExten(30)
exten => pickup_unavailable,10,Hangup()


;redirect to voicemail
exten => 1,1,Log(NOTICE, redirect to voicemail from ${CALLERID(all)} )
exten => 1,n,VoiceMail(6001) 
exten => 1,n,Hangup()

;redirect to all
exten => 2,1,Log(NOTICE, redirect Call from ${CALLERID(all)} )
exten => 2,n,Goto(call,callall,1)
exten => 2,n,Hangup()

exten => 3,1,Log(NOTICE, give information to ${CALLERID(all)} )
exten => 3,2,GotoIf($[${dutch} = 1]?,7)
exten => 3,3,Background(${SHELL(/opt/sascha/tts/gen_info.en.php)})
exten => 3,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => 3,5,WaitExten(30)
exten => 3,6,Hangup()
exten => 3,7,Background(${SHELL(/opt/sascha/tts/gen_info.nl.php)})
exten => 3,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => 3,9,WaitExten(30)
exten => 3,10,Hangup()

;enter system password
exten => 1234,1,Log(NOTICE, entrycode ${CALLERID(all)} )
exten => 1234,n,Goto(sascha_sys,pickup,1)
exten => 1234,n,Hangup()

exten => e,1,Goto(pickup,1)

[sascha_sys]
exten => pickup,1,Log(NOTICE, Enter system ${CALLERID(all)} )
exten => pickup,2,Background(${SHELL(/opt/sascha/tts/gen_sys_list.php)})
exten => pickup,3,WaitExten(30)
exten => pickup,4,Hangup()

exten => 1,1,VoiceMailMain(6001)
exten => 1,2,Goto(pickup,1)

exten => 2,1,Read(my_time,wektijd,4) ; Prompt the user to enter the time using four digits (HHMM)
exten => 2,2,Set(my_hours=${my_time:0:2}) ; Get the first two characters (hours) of my_time
exten => 2,3,Set(my_minutes=${my_time:2:2}) ; Get the last two characters (minutes) of my_time
exten => 2,4,System(/opt/sascha/wakeup/store_wakeup_time.php ${CALLERID(num)} ${my_hours} ${my_minutes})
exten => 2,5,Log(NOTICE,The time entered was ${my_hours} hours and ${my_minutes} minutes) ; Display the hours and minutes
exten => 2,6,System(/opt/asterisk/gen_wektijd.php ${my_hours} ${my_minutes});
exten => 2,7,Playback(wektijd_${my_hours}_${my_minutes});
exten => 2,8,Goto(pickup,1)



[wakeup]
exten => wakeup_slaapkamer,1,log(NOTICE, wakup ${caller})
exten => wakeup_slaapkamer,2,Dial(PJSIP/${caller},60)
exten => wakeup_slaapkamer,3,Background(${SHELL(/opt/sascha/tts/gen_greet_nl.php)})
exten => wakeup_slaapkamer,4,System(/opt/sascha/scriptrun.php anp_nieuws_wekker)
exten => wakeup_slaapkamer,5,Hangup()

exten => wakeup_studeer,1,log(NOTICE, wakup ${caller})
exten => wakeup_studeer,2,Dial(PJSIP/${caller},60)
exten => wakeup_studeer,3,PlayBack(nu_nl_nieuws)
exten => wakeup_studeer,4,Hangup()


exten => wakeup_out,1,Set(DEVICE=${DB(phones/sacha/wakeupcall)})
exten => wakeup_out,n,log(NOTICE, wakup ${DEVICE})
exten => wakeup_out,n,Dial(SIP/0100,,D(www${DEVICE}),30)
exten => wakeup_out,n,Set(COUNTER=0)
exten => wakeup_out,n,While([${COUNTER}<=6])
exten => wakeup_out,n,Background(${SHELL(/opt/sascha/tts/wakeup_press_1.php)})
exten => wakeup_out,n,Set(COUNTER=$[${COUNTER}+1])
exten => wakeup_out,n,log(NOTICE, wakup ${COUNTER})
exten => wakeup_out,n,EndWhile()
exten => wakeup_out,n,Hangup()

exten => 1,1,log(NOTICE, play news)
exten => 1,n,PlayBack(nu_nl_nieuws)
exten => 1,n,Hangup()




[anonymous]
exten => in,1,log(NOTICE, anonymous Call pickup ${CALLERID(all)})
exten => in,n,Answer(500)
exten => in,n,Background(press_1_to_continue_nl)
exten => in,n,Background(press_1_to_continue)
exten => in,n,WaitExten(30)
exten => in,n,Hangup()

exten => 1,1,log(NOTICE, anonymous Call accept )
exten => 1,n,Goto(pstn-incoming,1234,4)

[call]

exten => callall,1,log(NOTICE, Call to all from ${CALLERID(all)} )
exten => callall,n,Dial(PJSIP/6001&PJSIP/6002&SIP/6010/&PJSIP/6011,30,t)
exten => callall,n,Goto(sascha_pickup,pickup,1)
exten => callall,n,Set(SAVE=${CALLERID(NUM)})
exten => callall,n,Set(CALLERID(num)=${IF($[${SAVE:0:1} = 0]?5555:5554)})
exten => callall,n,Log(NOTICE, Pickup Karin ${CALLERID(num)} )
exten => callall,n,System(/opt/gnomepub/smskarinpickup.sh) 
exten => callall,n,Set(CALLERID(NAME)=${SHELL(cat /opt/vcf2asterisk/name)})
exten => callall,n,Dial(PJSIP/6021&PJSIP/6023,14,t)
exten => callall,n,Set(CALLERID(NUM)=${SAVE})
exten => callall,n,Log(NOTICE, Transfer to asterisk )
exten => callall,n,Goto(asterisk,pickup,1)
exten => callall,n,HangUp()



;exten => blacklist,1,log(NOTICE, Blacklisted call from ${CALLERID(all)} )
;exten => blacklist,n,Set(SAVE=${CALLERID(NUM)})
;exten => blacklist,n,Set(CALLERID(NUM)=5556)
;exten => blacklist,n,Dial(PJSIP/6021&PJSIP/6023,7,t)
;exten => blacklist,n,Set(CALLERID(NUM)=${SAVE})
;exten => blacklist,n,Set(CALLERID(NAME)=blacklisted ${CALLERID(NUM)})
;exten => blacklist,n,VoiceMail(6001)

[blacklist]

exten => blacklist,1,log(NOTICE, Blacklisted call from ${CALLERID(all)} )
exten => blacklist,2,Background(${SHELL(/opt/sascha/tts/gen_banned.php)})
exten => blacklist,3,Background(${SHELL(/opt/sascha/tts/gen_qoute_en.php)})
exten => blacklist,4,WaitExten(30)
exten => blacklist,5,Hangup()

;redirect to voicemail
exten => 1,1,Log(NOTICE, redirect to voicemail from blacklisted ${CALLERID(all)} )
exten => 1,n,Set(CALLERID(NAME)=blacklisted ${CALLERID(NUM)})
exten => 1,n,VoiceMail(6001) 
exten => 1,n,Hangup()


[karin]
;redirect to voicemail
exten => 1,1,Set(CALLERID(NUM)=${SAVE})
exten => 1,n,Log(NOTICE, redirect to voicemail from ${CALLERID(all)} )
exten => 1,n,VoiceMail(6001) 
exten => 1,n,Hangup()

;redirect to all
exten => 2,1,Set(CALLERID(NUM)=${SAVE})
exten => 2,n,Log(NOTICE, redirect Call from ${CALLERID(all)} )
exten => 2,n,Goto(call,callall,1)
exten => 2,n,Hangup()

;blacklisted redirect to voicemail
exten => 5,1,Set(CALLERID(NUM)=${SAVE})
exten => 5,n,Set(CALLERID(NAME)=blacklisted ${CALLERID(NUM)})
exten => 5,n,VoiceMail(6001)
exten => 5,n,Hangup()

;redirect to handfree 
exten => 6,1,Set(CALLERID(NUM)=${SAVE})
exten => 6,2,Log(NOTICE, redirect spider speaker )
exten => 6,3,Dial(PJSIP/6013,60,tT)
exten => 6,4,Hangup()


;blacklist number 
exten => 7,1,Set(CALLERID(NUM)=${SAVE})
exten => 7,2,GotoIf($["${CALLERID(num)}" : "6[0-9]{3}"]?7)
exten => 7,3,GotoIf($["${CALLERID(num)}" = "0100"]?6)
exten => 7,4,Log(NOTICE, Add ${CALLERID(all)} to blacklist)
exten => 7,5,SET(DB(blacklist/${CALLERID(NUM)})=1)
exten => 7,6,GOTO(call,blacklist,1)
exten => 7,7,Hangup()

;call users
exten => 6010,1,Log(NOTICE, Dialing local from ${CALLERID(all)} to ${EXTEN})
exten => 6010,n,Dial(SIP/6010,60,tT)
exten => 6010,n,Hangup()

exten => _6.,1,Log(NOTICE, Dialing local from ${CALLERID(all)} to ${EXTEN})
exten => _6.,n,Dial(PJSIP/${EXTEN},60,tT)
exten => _6.,n,Hangup()


[users]
;pickup handsfree
exten => 77,1,Log(NOTICE, redirect spider speaker )
exten => 77,2,System(/usr/bin/ssh daft@192.168.5.6 /usr/bin/bluetoothctl disconnect 30:21:43:39:4E:EA)
exten => 77,3,System(/usr/bin/ssh daft@192.168.5.3 /usr/bin/bluetoothctl connect 30:21:43:39:4E:EA)
exten => 77,4,Dial(PJSIP/6013,60,tT)
exten => 77,5,Hangup()

;pickup incomming call
exten => 88,1,LOG(NOTICE, all pickup)
exten => 88,n,ChannelRedirect(${SHELL(asterisk -x "core show channels" | grep SIP/0100- | cut -d" " -f1| tr -d '\n')},karin,2,1)
exten => 88,n,Wait(1)
exten => 88,n,PickupChan(PJSIP/6001&PJSIP/6002&SIP/6010/&PJSIP/6011)

;blacklist number
exten => 99,1,GotoIf($["${CALLERID(num)}" : "6[0-9]{3}"]?6)
exten => 99,2,GotoIf($["${CALLERID(num)}" = "0100"]?5)
exten => 99,3,Log(NOTICE, Add ${CALLERID(all)} to blacklist)
exten => 99,4,SET(DB(blacklist/${CALLERID(NUM)})=1)
exten => 99,5,GOTO(blacklist,blacklist,1)
exten => 99,6,Hangup()


exten => 97,1,NoOp(Adding to blacklist)
 same => n,Read(number_to_blacklist,please-enter-the-number-to-blacklist,10,,3)
 same => n,Set(DB(blacklist/${number_to_blacklist})=1)
 same => n,Playback(the-number-has-been-blacklisted)
 same => n,Hangup()

exten => 98,1,NoOp(Removing from blacklist)
 same => n,Read(number_to_remove,please-enter-the-number-to-remove-from-the-blacklist,10,,3)
 same => n,Set(DB(blacklist/${number_to_remove})=0)
 same => n,Playback(the-number-has-been-removed-from-the-blacklist)
 same => n,Hangup()



