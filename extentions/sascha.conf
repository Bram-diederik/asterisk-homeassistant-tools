[sacha_incomming]
exten => incomming,1,log(NOTICE, sascha ${CALLERID(num)} )
exten => incomming,2,GotoIF($[("${CALLERID(num)}") = "anonymous"]?anonymous,in,1)
exten => incomming,3,GotoIf($["${DB(denylist/${CALLERID(num)})}" = "1"]?denylist,denylist,1)
exten => incomming,4,Log(NOTICE, Call from ${CALLERID(num)} )
exten => incomming,5,System(/opt/sascha/nextcloud/search_name.php ${CALLERID(num)})
exten => incomming,6,Set(CALLERID(NAME)=${SHELL(cat /opt/sascha/nextcloud/name.txt)})
exten => incomming,7,Log(NOTICE, ${SHELL(cat /opt/sascha/nextcloud/group.txt)} ${CALLERID(num)} )
exten => incomming,8,GotoIf($["${SHELL(/opt/sascha/asterisk/number_redirect.php ${CALLERID(num)})}" = "true"]?11)
exten => incomming,9,GotoIf($["${SHELL(/opt/sascha/asterisk/read.php "${SHELL(cat /opt/sascha/nextcloud/group.txt)}") }" = "0"]?15)
exten => incomming,10,GotoIf($["${SHELL(grep -q ${CALLERID(num)} /opt/sascha/nextcloud/calendar_calls.txt && echo -n found || echo -n notfound)}" = "found"])?,15)
exten => incomming,11,Log(NOTICE, Pickup Sascha ${CALLERID(num)} )
exten => incomming,12,System(/opt/gnomepub/smskarinpickup.sh&) 
exten => incomming,13,Goto(sascha_pickup,pickup,1)
exten => incomming,14,HangUp()
exten => incomming,15,System(/opt/sascha/homeassistant/tts_speak.php nl media_player.googlehome8005 "Inkomende beller ${CALLERID(NAME)}")
exten => incomming,16,System(/opt/sascha/homeassistant/scriptrun.php tts_sascha '{ "message": "Inkomende beller ${CALLERID(NAME)}" }')
exten => incomming,17,Goto(call,callall,1)
exten => incomming,18,Hangup()


[sascha_pickup]
exten => pickup,1,log(NOTICE, sascha call pickup ${CALLERID(num)} ${CALLERID(num):1:2} ) 
exten => pickup,2,Set(dutch=${IF($[${CALLERID(num):1:2} = 31]?1:0)})
exten => pickup,3,System(/opt/sascha/homeassistant/tts_speak.php nl media_player.googlehome8005 "pickup ${CALLERID(NAME)}")
exten => pickup,4,GotoIf($["${SHELL(cat /opt/sascha/nextcloud/group.txt)}" = "very close"])?sascha_close,pickup,1)
exten => pickup,5,GotoIf($["${SHELL(cat /opt/sascha/nextcloud/group.txt)}" = "close"])?sascha_close,pickup,1) 
exten => pickup,6,GotoIf($["${SHELL(cat /opt/sascha/nextcloud/group.txt)}" = "all"])?sascha_none,pickup_all,1) 
exten => pickup,7,Goto(sascha_none,pickup_none,1)

[sascha_none]

exten => pickup_none,1,log(NOTICE, sascha none call pickup)
exten => pickup_none,2,GotoIfTime(21:00-23:59|*|*|*?pickup_late_none,1)
exten => pickup_none,3,GotoIfTime(00:00-08:00|*|*|*?pickup_late_none,1)
exten => pickup_none,4,Goto(pickup_unavailable_none,1)

exten => pickup_all,1,log(NOTICE, sascha all call pickup)
exten => pickup_all,2,GotoIf($["${SHELL(cat /opt/HA/busy)}" = "on"])?pickup_busy_all,1)
exten => pickup_all,3,GotoIf($["${SHELL(cat /opt/HA/calendar_item)}" != "off"])?pickup_calendar_all,1)
exten => pickup_all,4,GotoIfTime(21:00-23:59|*|*|*?pickup_late_all,1)
exten => pickup_all,5,GotoIfTime(00:00-08:00|*|*|*?pickup_late_all,1)
exten => pickup_all,6,Goto(pickup_unavailable_all,1)


exten => pickup_late_none,1,log(NOTICE, sascha late none call pickup)
exten => pickup_late_none,2,GotoIf($[${dutch} = 1]?,8)
exten => pickup_late_none,3,log(NOTICE, sascha pickup late English)
exten => pickup_late_none,4,Background(${SHELL(/opt/sascha/tts/gen_late_none_en.php)})
exten => pickup_late_none,5,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_late_none,6,WaitExten(30)
exten => pickup_late_none,7,Hangup()
exten => pickup_late_none,8,Background(${SHELL(cat /opt/sascha/tts/gen_late_none_nl.php)})
exten => pickup_late_none,9,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_late_none,10,WaitExten(30)
exten => pickup_late_none,11,Hangup()

exten => pickup_unavailable_none,1,log(NOTICE, sascha unavailable none call pickup )
exten => pickup_unavailable_none,2,GotoIf($[${dutch} = 1]?,8)
exten => pickup_unavailable_none,3,log(NOTICE, sascha pickup unavailable English)
exten => pickup_unavailable_none,4,Background(${SHELL(/opt/sascha/tts/gen_unavailable_none_en.php)})
exten => pickup_unavailable_none,5,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_unavailable_none,6,WaitExten(30)
exten => pickup_unavailable_none,7,Hangup()
exten => pickup_unavailable_none,8,Background(${SHELL(/opt/sascha/tts/gen_unavailable_none_nl.php)})
exten => pickup_unavailable_none,9,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_unavailable_none,10,WaitExten(30)
exten => pickup_unavailable_none,11,Hangup()


exten => pickup_late_all,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_late_all,2,log(NOTICE, sascha pickup late English)
exten => pickup_late_all,3,Background(${SHELL(/opt/sascha/tts/gen_late_all_en.php)})
exten => pickup_late_all,4,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_late_all,5,WaitExten(30)
exten => pickup_late_all,6,Hangup()
exten => pickup_late_all,7,Background(${SHELL(/opt/sascha/tts/gen_late_all_nl.php)})
exten => pickup_late_all,8,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_late_all,9,WaitExten(30)
exten => pickup_late_all,10,Hangup()

exten => pickup_busy_all,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_busy_all,2,log(NOTICE, sascha pickup busy English)
exten => pickup_busy_all,3,Background(${SHELL(/opt/sascha/tts/gen_busy_all_en.php)})
exten => pickup_busy_all,4,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_busy_all,5,WaitExten(30)
exten => pickup_busy_all,6,Hangup()
exten => pickup_busy_all,7,Background(${SHELL(/opt/sascha/tts/gen_busy_all_nl.php)})
exten => pickup_busy_all,8,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_busy_all,9,WaitExten(30)
exten => pickup_busy_all,10,Hangup()

exten => pickup_calendar_all,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_calendar_all,2,log(NOTICE, sascha pickup calendar English)
exten => pickup_calendar_all,3,Background(${SHELL(/opt/sascha/tts/gen_calendar_all_en.php)})
exten => pickup_calendar_all,4,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_calendar_all,5,WaitExten(30)
exten => pickup_calendar_all,6,Hangup()
exten => pickup_calendar_all,7,Background(${SHELL(/opt/sascha/tts/gen_calendar_all_nl.php)})
exten => pickup_calendar_all,8,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_calendar_all,9,WaitExten(30)
exten => pickup_calendar_all,10,Hangup()

exten => pickup_unavailable_all,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_unavailable_all,2,log(NOTICE, sascha pickup unavailable English)
exten => pickup_unavailable_all,3,Background(${SHELL(/opt/sascha/tts/gen_unavailable_all_en.php)})
exten => pickup_unavailable_all,4,Background(${SHELL(/opt/sascha/tts/choice_none_en.php)})
exten => pickup_unavailable_all,5,WaitExten(30)
exten => pickup_unavailable_all,6,Hangup()
exten => pickup_unavailable_all,7,Background(${SHELL(/opt/sascha/tts/gen_unavailable_all_nl.php)})
exten => pickup_unavailable_all,8,Background(${SHELL(/opt/sascha/tts/choice_none_nl.php)})
exten => pickup_unavailable_all,9,WaitExten(30)
exten => pickup_unavailable_all,10,Hangup()


;redirect to voicemail
exten => 1,1,Log(NOTICE, redirect to voicemail from ${CALLERID(all)} )
exten => 1,n,VoiceMail(6001) 
exten => 1,n,Hangup()

;enter password
exten => 1234,1,Log(NOTICE, entrycode ${CALLERID(all)} )
exten => 1234,n,Goto(sascha_close,pickup,1)
exten => 1234,n,Hangup()

exten => e,1,Goto(pickup_none,1)



[sascha_close]
exten => pickup,1,log(NOTICE, sascha close call pickup)
exten => pickup,2,GotoIf($["${SHELL(cat /opt/HA/busy)}" = "on"])?pickup_busy,1)
exten => pickup,3,GotoIf($["${SHELL(cat /opt/HA/calendar_item)}" != "off"])?pickup_calendar,1)
exten => pickup,4,GotoIfTime(22:30-23:59|*|*|*?pickup_late,1)
exten => pickup,5,GotoIfTime(00:00-08:00|*|*|*?pickup_late,1)
exten => pickup,6,Goto(pickup_unavailable,1)

exten => pickup_busy,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_busy,2,log(NOTICE, sascha pickup busy English)
exten => pickup_busy,3,Background(${SHELL(/opt/sascha/tts/gen_busy_close_en.php)})
exten => pickup_busy,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => pickup_busy,5,WaitExten(30)
exten => pickup_busy,6,Hangup()
exten => pickup_busy,7,Background(${SHELL(/opt/sascha/tts/gen_busy_close_nl.php)})
exten => pickup_busy,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => pickup_busy,9,WaitExten(30)
exten => pickup_busy,10,Hangup()


exten => pickup_late,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_late,2,log(NOTICE, sascha pickup late English)
exten => pickup_late,3,Background(${SHELL(/opt/sascha/tts/gen_late_close_en.php)})
exten => pickup_late,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => pickup_late,5,WaitExten(30)
exten => pickup_late,6,Hangup()
exten => pickup_late,7,Background(${SHELL(/opt/sascha/tts/gen_late_close_nl.php)})
exten => pickup_late,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => pickup_late,9,WaitExten(30)
exten => pickup_late,10,Hangup()

exten => pickup_calendar,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_calendar,2,log(NOTICE, sascha pickup calendar English)
exten => pickup_calendar,3,Background(${SHELL(/opt/sascha/tts/gen_calendar_close_en.php)})
exten => pickup_calendar,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => pickup_calendar,5,WaitExten(30)
exten => pickup_calendar,6,Hangup()
exten => pickup_calendar,7,Background(${SHELL(/opt/sascha/tts/gen_calendar_close_nl.php)})
exten => pickup_calendar,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => pickup_calendar,9,WaitExten(30)
exten => pickup_calendar,10,Hangup()

exten => pickup_unavailable,1,GotoIf($[${dutch} = 1]?,7)
exten => pickup_unavailable,2,log(NOTICE, sascha pickup unavailable English)
exten => pickup_unavailable,3,Background(${SHELL(/opt/sascha/tts/gen_unavailable_close_en.php)})
exten => pickup_unavailable,4,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => pickup_unavailable,5,WaitExten(30)
exten => pickup_unavailable,6,Hangup()
exten => pickup_unavailable,7,Background(${SHELL(/opt/sascha/tts/gen_unavailable_close_nl.php)})
exten => pickup_unavailable,8,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => pickup_unavailable,9,WaitExten(30)
exten => pickup_unavailable,10,Hangup()


;redirect to voicemail
exten => 1,1,Log(NOTICE, redirect to voicemail from ${CALLERID(all)} )
exten => 1,n,VoiceMail(6001) 
exten => 1,n,Hangup()

;redirect to all
exten => 2,1,Log(NOTICE, redirect Call from ${CALLERID(all)} )
exten => 2,n,System(/opt/sascha/homeassistant/scriptrun.php unmute_torch)
exten => 2,n,Goto(call,callall,1)
exten => 2,n,Hangup()

exten => 3,1,Log(NOTICE, give information to ${CALLERID(all)} )
exten => 3,2,GotoIf($[${dutch} = 1]?,8)
exten => 3,3,Background(${SHELL(/opt/sascha/gentts.php en "One moment please")})
exten => 3,4,Background(${SHELL(/opt/sascha/tts/gen_info.en.php)})
exten => 3,5,Background(${SHELL(/opt/sascha/tts/choice_close_en.php)})
exten => 3,6,WaitExten(30)
exten => 3,7,Hangup()
exten => 3,8,Background(${SHELL(/opt/sascha/gentts.php nl "een moment aub")})
exten => 3,9,Background(${SHELL(/opt/sascha/tts/gen_info.nl.php)})
exten => 3,10,Background(${SHELL(/opt/sascha/tts/choice_close_nl.php)})
exten => 3,11,WaitExten(30)
exten => 3,12,Hangup()

;enter system password
exten => 2345,1,Log(NOTICE, entrycode ${CALLERID(all)} )
exten => 2345,n,Goto(sascha_sys,pickup,1)
exten => 2345,n,Hangup()

exten => e,1,Goto(pickup,1)

[sascha_sys]
exten => pickup,1,Log(NOTICE, Enter system ${CALLERID(all)} )
exten => pickup,2,Background(${SHELL(/opt/sascha/tts/gen_sys_list.php)})
exten => pickup,3,WaitExten(30)
exten => pickup,4,Hangup()

exten => 1,1,VoiceMailMain(6001)
exten => 1,2,Goto(pickup,1)

exten => 2,1,Log(NOTICE, Enter wektijd ${CALLERID(all)} )
exten => 2,2,Read(my_time,${SHELL(/opt/sascha/gentts.php nl "toets wektijd vier didgits")},4) ; Prompt the user to enter the time using four digits (HHMM)
exten => 2,3,Set(my_hours=${my_time:0:2}) ; Get the first two characters (hours) of my_time
exten => 2,4,Set(my_minutes=${my_time:2:2}) ; Get the last two characters (minutes) of my_time
exten => 2,5,System(/opt/sascha/wakeup/store_wakeup_time.php ${CALLERID(num)} ${my_hours} ${my_minutes})
exten => 2,6,Log(NOTICE,The time entered was ${my_hours} hours and ${my_minutes} minutes) ; Display the hours and minutes
exten => 2,7,System(/opt/asterisk/gen_wektijd.php ${my_hours} ${my_minutes});
exten => 2,8,Playback(wektijd_${my_hours}_${my_minutes});
exten => 2,9,Goto(pickup,1)

exten => 3,1,Log(NOTICE, BEL NAAR KARIN)
exten => 3,n,Dial(PJSIP/homeassistant-nl,20)


exten => 9,1,Playback(${SHELL(/opt/sascha/gentts.php nl "restart spider")})
exten => 9,2,System(ssh daft@spider sudo reboot);
exten => 9,3,Goto(pickup,1)


exten => e,1,Goto(pickup,1)


[wakeup]
exten => wakeup_slaapkamer,1,log(NOTICE, wakeup ${caller})
exten => wakeup_slaapkamer,2,Dial(PJSIP/${caller},60)
exten => wakeup_slaapkamer,3,Background(${SHELL(/opt/sascha/tts/gen_greet_nl.php)})
exten => wakeup_slaapkamer,4,System(/opt/sascha/scriptrun.php anp_nieuws_wekker)
exten => wakeup_slaapkamer,5,Hangup()

exten => wakeup_studeer,1,log(NOTICE, wakup ${caller})
exten => wakeup_studeer,2,Dial(PJSIP/${caller},60)
exten => wakeup_studeer,3,PlayBack(nu_nl_nieuws)
exten => wakeup_studeer,4,Hangup()


exten => wakeup_out,1,Set(DEVICE=${DB(phones/sacha/wakeupcall)})
exten => wakeup_out,n,log(NOTICE, wakup ${DEVICE})
exten => wakeup_out,n,Set(CALLERID(num)=+1234567890)  
exten => wakeup_out,n,Set(CALLERID(name)="daft_dutch") 
exten => wakeup_out,n,Dial(PJSIP/{DEVICE}@12c,30)
exten => wakeup_out,n,Set(COUNTER=0)
exten => wakeup_out,n,While([${COUNTER}<=6])
exten => wakeup_out,n,Background(${SHELL(/opt/sascha/tts/wakeup_press_1.php)})
exten => wakeup_out,n,Set(COUNTER=$[${COUNTER}+1])
exten => wakeup_out,n,log(NOTICE, wakup ${COUNTER})
exten => wakeup_out,n,EndWhile()
exten => wakeup_out,n,Hangup()

exten => 1,1,log(NOTICE, play news)
exten => 1,n,PlayBack(nu_nl_nieuws)
exten => 1,n,Hangup()


exten => e,1,Goto(1,1)


[anonymous]
exten => in,1,log(NOTICE, anonymous Call pickup ${CALLERID(all)})
exten => in,n,Answer(500)
exten => in,n,Monitor(wav,/tmp/${UNIQUEID}.wav)
exten => in,n,Background(${SHELL(/opt/sascha/gentts.php nl "beste anonieme beller druk 1 om door te gaan.")})
exten => in,n,Background(${SHELL(/opt/sascha/gentts.php en "dear anonymous caller press one to continue.")})
exten => in,n,Background(${SHELL(/opt/sascha/gentts.php nl "omdat u anoniem belt wordt dit gesprek tijdelijk opgenomen.")})
exten => in,n,Background(${SHELL(/opt/sascha/gentts.php en "This call will be recorded and saved temporarly because youre calling anonymously")})
exten => in,n,Background(${SHELL(/opt/sascha/gentts.php nl "beste anonieme beller druk 1 om door te gaan.")})
exten => in,n,Background(${SHELL(/opt/sascha/gentts.php en "dear anonymous caller press one to continue.")})
exten => in,n,Background(press_1_to_continue_nl)
exten => in,n,Background(press_1_to_continue)
exten => in,n,WaitExten(30)
exten => in,n,Hangup()

exten => 1,1,log(NOTICE, anonymous Call accept )
;exten => 1,n,StopMonitor()
exten => 1,n,Goto(pstn-incoming,+31238443064,4)

exten => e,1,Goto(in,1)

[call]

exten => callall,1,log(NOTICE, Call to all from ${CALLERID(all)} )
exten => callall,n,Dial(${PJSIP_DIAL_CONTACTS(6001)}&${PJSIP_DIAL_CONTACTS(6002)}&${PJSIP_DIAL_CONTACTS(6003)}&${PJSIP_DIAL_CONTACTS(6004)}&PJSIP/6010/&PJSIP/6011,30)
exten => callall,n,Goto(sascha_pickup,pickup,1)
exten => callall,n,HangUp()

[denylist]

exten => denylist,1,log(NOTICE, denylisted call from ${CALLERID(all)} )
exten => denylist,2,Background(${SHELL(/opt/sascha/tts/gen_banned.php)})
exten => denylist,3,Background(${SHELL(/opt/sascha/tts/gen_qoute_en.php)})
exten => denylist,4,WaitExten(10)
exten => denylist,5,Hangup()

;redirect to voicemail
exten => 1,1,Log(NOTICE, redirect to voicemail from denylisted ${CALLERID(all)} )
exten => 1,n,Set(CALLERID(NAME)=denylisted ${CALLERID(NUM)})
exten => 1,n,VoiceMail(6001) 
exten => 1,n,Hangup()

exten => e,1,Hangup()

[karin]
;redirect to voicemail
exten => 1,1,Set(CALLERID(NUM)=${SAVE})
exten => 1,n,Log(NOTICE, redirect to voicemail from ${CALLERID(all)} )
exten => 1,n,VoiceMail(6001) 
exten => 1,n,Hangup()

;redirect to all
exten => 2,1,Set(CALLERID(NUM)=${SAVE})
exten => 2,n,Log(NOTICE, redirect Call from ${CALLERID(all)} )
exten => 2,n,Goto(call,callall,1)
exten => 2,n,Hangup()

;denylisted redirect to voicemail
exten => 5,1,Set(CALLERID(NUM)=${SAVE})
exten => 5,n,Set(CALLERID(NAME)=denylisted ${CALLERID(NUM)})
exten => 5,n,VoiceMail(6001)
exten => 5,n,Hangup()

;redirect to handfree 
exten => 6,1,Set(CALLERID(NUM)=${SAVE})
exten => 6,2,Log(NOTICE, redirect easy speaker )
exten => 6,3,Dial(${PJSIP_DIAL_CONTACTS(6014)},60,tT)
exten => 6,4,Hangup()


;denylist number 
exten => 7,1,Set(CALLERID(NUM)=${SAVE})
exten => 7,2,GotoIf($["${CALLERID(num)}" : "6[0-9]{3}"]?7)
exten => 7,3,GotoIf($["${CALLERID(num)}" = "0100"]?6)
exten => 7,4,Log(NOTICE, Add ${CALLERID(all)} to denylist)
exten => 7,5,SET(DB(denylist/${CALLERID(NUM)})=1)
exten => 7,6,GOTO(call,denylist,1)
exten => 7,7,Hangup()

;exten => 6010,1,Log(NOTICE, Dialing local from ${CALLERID(all)} to ${EXTEN})
;exten => 6010,n,Dial(SIP/6010,60,tT)
;exten => 6010,n,Hangup()

;call users
exten => _6.,1,Log(NOTICE, Dialing local from ${CALLERID(all)} to ${EXTEN})
exten => _6.,n,Dial(${PJSIP_DIAL_CONTACTS(${EXTEN})},60,tT)
exten => _6.,n,Hangup()
